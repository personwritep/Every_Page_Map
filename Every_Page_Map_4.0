// ==UserScript==
// @name        Every Page Map ğŸ’¢
// @namespace        http://tampermonkey.net/
// @version        4.0
// @description        ã€Œè¨˜äº‹ã®ç·¨é›†ãƒ»å‰Šé™¤ã€ãƒšãƒ¼ã‚¸ã§å…¨è¨˜äº‹ã®ã€Œå…¬é–‹è¨­å®šã€ã‚’è¨˜éŒ²ã™ã‚‹
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventrylist*
// @run-at        document-start
// ==/UserScript==


let retry=0;
let interval=setInterval(wait_target, 1);
function wait_target(){
    retry++;
    if(retry>100){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 100å› 0.1secã¾ã§
        clearInterval(interval); }
    let target=document.documentElement; // ç›£è¦– target
    if(target){
        clearInterval(interval);
        style_in(); }}


let blogDB={}; // è¨˜äº‹ID æŠ•ç¨¿ãƒ•ãƒ©ã‚° æŠ•ç¨¿å¹´æœˆ ã®é…åˆ—
let entry_id_DB; // IDæ¤œç´¢ç”¨ã®é…åˆ—
let blogMAP={}; // å…¬é–‹æƒ…å ±ã®ä»¶æ•°ãƒ‡ãƒ¼ã‚¿MAP

function write_MAP(){ // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ MAP ä¿å­˜
    let write_map_json=JSON.stringify(blogMAP);
    sessionStorage.setItem('blogMAP_back', write_map_json); }

function write_DB(){ // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ DB ä¿å­˜
    let write_json=JSON.stringify(blogDB);
    sessionStorage.setItem('blogDB_back', write_json); }



function style_in(){
    let read_json=sessionStorage.getItem('blogDB_back'); // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜å
    blogDB=JSON.parse(read_json);
    if(blogDB==null){
        blogDB=[['00000000000', 's', 0]]; } // è¨˜äº‹ID, æŠ•ç¨¿ãƒ•ãƒ©ã‚°, æŠ•ç¨¿å¹´æœˆ 6æ¡
    // åˆè¦ç´ ã®ã¿ã€€ '00000000000' ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ 's'/'c'/'e' æŠ½å‡ºè¡¨ç¤ºæŒ‡å®š 0ï½3
    if(blogDB[0][1]==0){ blogDB[0][1]='s'; } // æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®æ•‘æ¸ˆ


    let style=
        '<style id="EPS">'+
        '#globalHeader, #ucsHeader, #ucsMainLeft h1, .l-ucs-sidemenu-area, #ucsMainRight,'+
        '#ucsContent::before, #footerAd, #globalFooter, .selection-bar '+
        '{ display: none !important; } '+

        '#ucsContent { width: 840px !important; background: #fff; '+
        'box-shadow: 0 0 0 100vh #c5d8e1; border-radius: 0; }'+
        '#ucsMain { margin-top: 15px; padding: 0 !important; background: #fff; border-radius: 0; } '+
        '#ucsMainLeft { width: 838px !important; padding: 0 15px; float: none; } '+

        '#entryYear { width: 120px !important; } '+
        '#entryMonth li, #entryMonth #nowMonthLi { '+
        'padding: 2px 0 0 !important; width: 55.2px; border: none; } '+
        '#entryMonth li a:visited { color: #3970B5 !important; } '+

        '#entryListEdit form { display: flex; flex-direction: column } #entrySort { order: -2 }'+
        '.pagingArea { order: -1; position: relative !important; left: 0 !important; top: 0 !important; '+
        'padding: 4px 30px 4px 0; margin-bottom: -33px; background: #ddedf3 !important }'+
        '.pagingArea a { border: 1px solid #888 } .pagingArea .active{ border: 2px solid #0066cc }'+
        '.pagingArea a, .pagingArea .active, .pagingArea .disabled { font-size: 14px; line-height: 23px }'+
        '#sorting { margin: 38px 0 4px; padding: 4px 10px; height: 110px; '+
        'font: 14px Meiryo; background: #ddedf3; height: auto !important; }'+
        '#sorting .pagingArea, #sorting select, #sorting ul { display: none }'+
        'input { font-family: meiryo; font-size: 14px }'+

        '#div1 { color: #333; margin: 10px -10px 0 15px; }'+
        '#div2 { color: #000; margin: 8px 15px; border: 1px solid #888; background: #fafcfd; }'+
        '#list_snap { padding: 2px 0 0; margin: 7px 40px 7px 0; width: 210px; }'+
        '#reset { padding: 2px 0 0; margin-right: 20px; width: 60px; }'+
        '#export { padding: 2px 0 0; margin: 7px 10px 7px 0; width: 150px; }'+
        '#import_sw { padding: 2px 0 0; margin: 7px 10px 7px 0; width: 115px; }'+
        '#import_result { display: inline-flex; padding: 2px 0 0; margin: 7px 0; width: 160px; '+
        'overflow: hidden; white-space: nowrap; }'+
        '#import { display: none; }'+
        '#snap_result { display: inline-block; margin: 6px 12px 4px; white-space: nowrap; }'+
        '#div3 { position: relative; color: #333; margin: 10px 15px; }'+
        '#show_map, #start_page, #do_snap { padding: 2px 10px 0; margin-right: 20px; width: auto; }'+
        '#amb_menu2 { float: right; padding: 2px 10px 0; margin: 2px 4px 3px -20px; cursor: pointer; }'+
        '#amb_menu3 { padding: 2px 10px 0; margin: 0 0 0 20px; cursor: pointer; } '+
        '.help_EPM { position: absolute; bottom: -6px; right: -12px; } '+

        '.div_add { display: flex; flex-direction: row; justify-content: space-evenly; width: 758px; '+
        'margin: 8px 15px; padding: 4px 0; border: 1px solid #777; background: #fafcfd; } '+
        '.m.y_index { width: 80px; font-size: 18px; text-align: center; outline: none !important; } '+
        '.m.y_index p { border: none; padding: 1px 4px 0; } '+
        '.m.y_index .yt { font-size: 14px; color: #1976d2; margin: 0 -3px 0 2px; } '+
        '.m.y_index .ypt { font-size: 11px; font-weight: normal; text-align: right; '+
        'margin: 0; padding: 5px 7px 0 0; background: none !important; } '+
        '.m { display: flex; flex-direction: column; font: bold 14px Meiryo; width: 50px; text-align: right; } '+
        '.m:hover { outline: 2px solid #2196f3; cursor: pointer; } '+
        '.mt { font-size: 13px; color: #3970bc; padding: 4px 0 0 !important; height: 22px; '+
        'margin-bottom: 3px; text-align: center; border: none !important; } '+
        '.m p { padding-right: 14px; margin-top: -1px; border: 1px solid #ccc; outline-offset: -2px; } '+
        '.m:not(.y_index) p:not(.mt):hover { outline: 2px solid #2196f3; position: relative; z-index: 1; } '+
        '#com1 { padding: 2px 20px 0; margin: 5px 15px; '+
        'font: 14px Meiryo; color: #fff; background: red; } '+
        '#com2 { position: absolute; right: 26px; top: 6px; padding: 1px 6px 0; '+
        'font: 14px Meiryo; color: #fff; background: #000; } '+

        'input[value="entry_ym=100001"] + #entrySort { visibility: hidden; } '+
        'input[value="entry_ym=100001"] ~ #entryList { visibility: hidden; } '+
        '</style>';

    if(blogDB[0][2]==4){ // èª¿æŸ»ãƒ¢ãƒ¼ãƒ‰
        style +='<style>#div3 { display: none; }</style>'; }
    else if(blogDB[0][2]==5){ // ä»®çµ‚äº†ãƒ¢ãƒ¼ãƒ‰
        style= // åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç ´æ£„
            '<style id="EPS">'+
            'body { background: #c5d8e1; }'+
            '#ucsMainLeft h1 { color: #2196f3; }'+
            '#div0, #div1, #div2, #div3 { display: none; }</style>';
        blogDB[0][2]=0;
        write_DB(); }
    else{ // MAPè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        style +='<style>#div1, #div2 { display: none; }</style>'; }

    if(blogDB[0][2]!=0){ // æŠ½å‡ºè¡¨ç¤ºã®å ´åˆï¼ˆèª¿æŸ»ãƒ»ä»®çµ‚äº†ã¯çœãï¼‰
        style +=
            '<style>.entry-item { display: none; } '+
            'input[name="publish_flg"][value="'+ (blogDB[0][2] -1) +'"] + '+
            'input + .entry-item { display: block; }</style>'; }


    if(!document.querySelector('#EPS')){
        document.documentElement.insertAdjacentHTML('beforeend', style); }

} // style_in()



window.addEventListener('load', function(){
    let entry_id;
    let publish_f;
    let entry_date;
    let pub_all;
    let pub_dra;
    let pub_ame;

    let ua=0;
    let agent=window.navigator.userAgent.toLowerCase();
    if(agent.indexOf('firefox') > -1){ ua=1; } // Firefoxã®å ´åˆã®ãƒ•ãƒ©ã‚°


    let year; // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã®å¹´åº¦
    let month; // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã®æœˆ
    let year_index; // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®å¹´åº¦ã‚’è¨˜éŒ²ã™ã‚‹ MAPã®index

    let disp_year=document.querySelector('#year');
    year=parseInt(disp_year.textContent, 10);

    let disp_month=document.querySelector('#nowMonth');
    month=parseInt(disp_month.textContent.replace(/[^0-9]/g, ''),10);


    let read_json=sessionStorage.getItem('blogDB_back'); // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜å
    blogDB=JSON.parse(read_json);
    if(blogDB==null){
        blogDB=[['00000000000', 's', 0]]; } // è¨˜äº‹ID, æŠ•ç¨¿ãƒ•ãƒ©ã‚°, æŠ•ç¨¿å¹´æœˆ 6æ¡
    // åˆè¦ç´ ã®ã¿ã€€ '00000000000' ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ 's'/'c'/'e' æŠ½å‡ºè¡¨ç¤ºæŒ‡å®š 0ï½3
    if(blogDB[0][1]==0){ blogDB[0][1]='s'; } // æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®æ•‘æ¸ˆ


    blogMAP={}; // å…¬é–‹æƒ…å ±ã®ä»¶æ•°ãƒ‡ãƒ¼ã‚¿MAP
    let read_map_json=sessionStorage.getItem('blogMAP_back'); // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜å
    blogMAP=JSON.parse(read_map_json);
    if(blogMAP==null){
        blogMAP=[[['blog_map', 1000, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],
                  [0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0]]]; }

    year_index=-1;
    year_index=blogMAP.findIndex(function(elem){
        return elem[0][1]==year; }); // ç¾åœ¨ã®å¹´åº¦ã®MAPãƒ‡ãƒ¼ã‚¿ã®æœ‰ç„¡ã‚’èª¿ã¹ã‚‹

    if(year_index==-1){ // ç¾åœ¨ã®å¹´åº¦ã®MAPãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã¯å¹´åº¦æ ã‚’è¿½åŠ 
        year_index=blogMAP.length;
        blogMAP.push([['blog_map', year, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],
                      [0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0],[0, 0, 0]]);

        blogMAP.sort(function(a, b){ // å¹´åº¦ã®æ˜‡é †ã«ã‚½ãƒ¼ãƒˆ
            return b[0][1] - a[0][1]; });

        year_index=blogMAP.findIndex(function(elem){
            return elem[0][1]==year; }); // ã‚½ãƒ¼ãƒˆå¾Œã«year_indexã‚’å†å–å¾—

        write_MAP(); } // MAP ä¿å­˜



    reg_set();

    function reg_set(){
        let k;
        entry_id_DB=[]; // ãƒªã‚»ãƒƒãƒˆ
        pub_all=0;
        pub_dra=0;
        pub_ame=0;

        for(k=0; k<blogDB.length; k++){
            entry_id_DB[k]=blogDB[k][0]; // IDæ¤œç´¢ç”¨ã®é…åˆ—ã‚’ä½œæˆ
            if(blogDB[k][1]=='0'){
                pub_all +=1; continue; }
            if(blogDB[k][1]=='1'){
                pub_dra +=1; continue; }
            if(blogDB[k][1]=='2'){
                pub_ame +=1; continue; }}}


    if(year==1000){
        blog_start(); }// ãƒ–ãƒ­ã‚°ã®æœ€åˆã®è¨˜äº‹
    else{
        control_pannel(blogDB[0][1]); // ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‘ãƒãƒ«è¡¨ç¤º
        menu();
        now_year_disp(); // MAPã‚’è¡¨ç¤º
    } // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠè¡¨ç¤º



    function control_pannel(d){
        let box=document.querySelector('#sorting');
        if(box){

            let help_url="https://ameblo.jp/personwritep/entry-12874974697.html";

            let help_SVG=
                '<svg height="24" width="24" viewBox="0 0 210 220">'+
                '<path d="M89 22C71 25 54 33 41 46C7 81 11 142 50 171C58 177 68 182 78 '+
                '185C90 188 103 189 115 187C126 185 137 181 146 175C155 169 163 162 169 '+
                '153C190 123 189 80 166 52C147 30 118 18 89 22z" style="fill: #000;"></path>'+
                '<path d="M67 77C73 75 78 72 84 70C94 66 114 67 109 83C106 91 98 95 93 '+
                '101C86 109 83 116 83 126L111 126C112 114 122 108 129 100C137 90 141 76 '+
                '135 64C127 45 101 45 84 48C80 49 71 50 68 54C67 56 67 59 67 61L67 77M'+
                '85 143L85 166L110 166L110 143L85 143z" style="fill:#fff;"></path>'+
                '</svg>';


            let insert_div=
                '<div id="div0"></div>'+
                '<div id="div1">'+
                '<input id="list_snap" type="submit">'+
                '<input id="reset" type="submit" value="åˆæœŸåŒ–">'+
                '<input id="export" type="submit" value="MAPã‚’ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜">'+
                '<input id="import_sw" type="submit" value="ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã¿">'+
                '<span id="import_result"></span>'+
                '<input id="import" type="file">'+
                '</div>'+
                '<div id="div2">'+
                '<span id="snap_result"></span>'+
                '<input id="amb_menu2" type="submit" value="èª¿æŸ»ã‚’çµ‚äº† â">'+
                '</div>'+
                '<div id="div3">'+
                '<input id="show_map" type="submit" value="MAPå…¨ä½“ã‚’è¡¨ç¤º">'+
                '<input id="start_page" type="submit" value="â—™ ãƒ–ãƒ­ã‚°ã®æœ€åˆã‚’è¡¨ç¤ºã™ã‚‹">'+
                '<input id="do_snap" type="submit" value="MAPã®èª¿æŸ»ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†">'+
                '<input id="amb_menu3" type="submit" value="é€šå¸¸è¡¨ç¤ºã«æˆ»ã‚‹ â">'+
                '<a class="help_EPM" href="'+ help_url +'">'+ help_SVG +'</a>'+
                '</div>';

            if(!box.querySelector('#div0')){
                box.insertAdjacentHTML('beforeend', insert_div); }



            let button1=box.querySelector('#list_snap');
            let button2=box.querySelector('#reset');
            let button3=box.querySelector('#export');
            let button4=box.querySelector('#import_sw');
            let span5=box.querySelector('#import_result');
            let input6=box.querySelector('#import');
            let span7=box.querySelector('#snap_result');


            if(d=='s'){
                button1.value='MAPã®èª¿æŸ»ã‚’é–‹å§‹ã€€â–¶';
                button1.onclick=function(e){
                    e.preventDefault();
                    start(); }

                function start(){
                    let conf_str=
                        ['ã€€ã€€ ğŸ”´ã€€ã“ã®ãƒšãƒ¼ã‚¸ä»¥é™ã®è¨˜äº‹ã«é–¢ã—ã¦ ã€Œå…¬é–‹è¨­å®šMAPã€ã‚’èª¿æŸ»ã—ã¾ã™',
                         '\nã€€ã€€ã€€ã€€  é€£ç¶šå‹•ä½œã¯ [ Ctrl ] ã‚­ãƒ¼ã‚’æŠ¼ã™ã‹ [ âšâš ] ã®ã‚¯ãƒªãƒƒã‚¯ã§åœæ­¢ã—ã¾ã™'].join(' ');
                    let ok=confirm(conf_str);
                    if(ok){
                        blogDB[0][1]='c'; // é€£ç¶šå‹•ä½œãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                        write_DB(); // DB ä¿å­˜
                        next(); }}}


            else if(d=='c'){ //ã€Œcã€ã¯é€£ç¶šå‹•ä½œ
                button2.style.display='none'; // å‹•ä½œãƒ¢ãƒ¼ãƒ‰ãŒã€Œcã€ã®å ´åˆã¯éè¡¨ç¤º
                button3.style.display='none'; // å‹•ä½œãƒ¢ãƒ¼ãƒ‰ãŒã€Œcã€ã®å ´åˆã¯éè¡¨ç¤º
                button4.style.display='none'; // å‹•ä½œãƒ¢ãƒ¼ãƒ‰ãŒã€Œcã€ã®å ´åˆã¯éè¡¨ç¤º
                span5.style.display='none'; // å‹•ä½œãƒ¢ãƒ¼ãƒ‰ãŒã€Œcã€ã®å ´åˆã¯éè¡¨ç¤º

                button1.value='MAPã®èª¿æŸ»ã‚’åœæ­¢ã€€ã€€âšâš';
                button1.style.width='760px';

                button1.onclick=function(e){
                    e.preventDefault();
                    stop(); }

                document.addEventListener('keydown', (e)=>{
                    if(e.ctrlKey){
                        e.preventDefault();
                        stop(); }});

                function stop(){
                    blogDB[0][1]='s'; // é€£ç¶šå‹•ä½œãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                    write_DB(); // DB ä¿å­˜
                    button1.value='MAPã®èª¿æŸ»ã‚’ç¶šè¡Œã€€â–¶';
                    button1.style.pointerEvents='none';
                    box.style.background='#96b6d2';

                    setTimeout(()=>{
                        button1.style.pointerEvents='auto';
                        button1.onclick=function(e){
                            e.preventDefault();
                            blogDB[0][1]='c'; // é€£ç¶šå‹•ä½œãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                            write_DB(); // DB ä¿å­˜
                            location.reload(); }}, 500); }

                setTimeout(()=>{
                    if(blogDB[0][1]=='c'){
                        next(); }}, 1000); } // é€£ç¶šå®Ÿè¡Œã®ãºãƒ¼ã‚¸é·ç§»ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚° 1sec â­•


            else if(d=='e'){ // ã€Œeã€ã¯çµ‚äº†
                button1.value='ğŸ”µ MAPèª¿æŸ»ãŒçµ‚äº†ã—ã¾ã—ãŸ';
                button1.onclick=function(e){ // èª¿æŸ»ã®çŠ¶æ…‹ã«å¾©å¸°
                    e.preventDefault();
                    blogDB[0][2]=4;
                    write_DB();
                    location.reload(); }}


            if(d=='s' || d=='e'){
                button2.onclick=function(e){ // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                    e.preventDefault();
                    blogDB=[['00000000000', 's']];
                    write_DB(); // DB ä¿å­˜
                    snap_disp();
                    button2.value='ã€”ã€€ã€•';
                    span5.textContent='';
                    input6.value='';

                    for(let k=0; k<blogMAP.length; k++){
                        for(let m=1; m<13; m++){ // m=0 ã®å¹´åº¦è¡¨ç¤ºã¯æ®‹ã™
                            blogMAP[k][m]=[0, 0, 0]; }}
                    write_MAP(); // MAP ä¿å­˜
                    now_year_disp(); } // MAPã‚’è¡¨ç¤º

                button3.onclick=function(e){
                    e.preventDefault();
                    let write_json=JSON.stringify(blogMAP);
                    let blob=new Blob([write_json], {type: 'application/json'});
                    let a_elem=document.createElement('a');
                    a_elem.href=URL.createObjectURL(blob);
                    a_elem.download='blogMAP.json'; // ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
                    if(ua==1){
                        a_elem.target='_blank';
                        document.body.appendChild(a_elem); }
                    a_elem.click();
                    if(ua==1){
                        document.body.removeChild(a_elem); }
                    URL.revokeObjectURL(a_elem.href); }

                button4.onclick=function(e){
                    e.preventDefault();
                    input6.click(); }

                input6.addEventListener("change", function(){
                    if(!(input6.value)) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã„å ´åˆ
                    let file_list=input6.files;
                    if(!file_list) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒé¸æŠã•ã‚Œãªã„å ´åˆ
                    let file=file_list[0];
                    if(!file) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆ

                    let file_reader=new FileReader();
                    file_reader.readAsText(file);
                    file_reader.onload=function(){
                        if(file_reader.result.slice(0, 14)=='[[["blog_map",'){ // blogMAP.jsonã®ç¢ºèª
                            let data_in=JSON.parse(file_reader.result);
                            blogMAP=data_in; // èª­è¾¼ã¿ä¸Šæ›¸ãå‡¦ç†
                            write_MAP(); // MAP ä¿å­˜

                            button2.value='åˆæœŸåŒ–'; // åˆæœŸåŒ–å¾Œãªã‚‰èª­ã¿è¾¼ã‚“ã äº‹ã‚’ç¤ºã™
                            snap_disp();
                            span5.textContent=file.name;
                            now_year_disp(); }// MAPã‚’è¡¨ç¤º
                        else{
                            alert(
                                "   â›” ä¸é©åˆãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™  \n"+
                                "blogMAP(n).json ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); }}
                }); }

            snap_disp();

        } // if(box)

    } // control_pannel()



    function snap_disp(){
        reg_set();
        let span7=document.querySelector('#snap_result');
        span7.innerHTML=
            'ã€€è¨˜éŒ²ä»¶æ•°ï¼š<b>' + (blogDB.length -1) +
            '</b>ã€€ã€€å…¨å“¡ã«å…¬é–‹ï¼š<b>' + pub_all +
            '</b>ã€€ã€€ã‚¢ãƒ¡ãƒ³ãƒãƒ¼é™å®šå…¬é–‹ï¼š<b>' + pub_ame +
            '</b>ã€€ã€€ä¸‹æ›¸ãï¼š<b>' + pub_dra; +'</b>'; }



    function next(){
        let win_url;
        let current;
        let pageid;
        let next_url;
        let pager;
        let end;

        entry_id=document.querySelectorAll('input[name="entry_id"]');
        if(entry_id.length >0){
            snap(); } // æŠ•ç¨¿è¨˜äº‹ãŒã‚ã‚‹å ´åˆSNAPã‚’å®Ÿè¡Œ ç„¡ã‘ã‚Œã°ã‚¹ãƒ«ãƒ¼ã™ã‚‹

        win_url=window.location.search.substring(1,window.location.search.length);
        current=win_url.slice(-6);
        if(!current){ current=make_curr(); }

        if(win_url.indexOf('pageID') ==-1){ // pageIDãŒç„¡ã„ æœˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®å ´åˆ
            pager=document.querySelector('.pagingArea');
            if(pager){ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ãŒæœ‰ã‚Šãã®æœ«å°¾ã§ãªã‘ã‚Œã°åŒæœˆæ¬¡ãƒšãƒ¼ã‚¸ã¸
                next_url=['https://blog.ameba.jp/ucs/entry/srventrylist.do?',
                          'pageID=2&entry_ym=' + current].join('');
                window.open( next_url, '_self'); }
            else{ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ãŒç„¡ã‘ã‚Œã°æ¬¡æœˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
                current=make_next(current);
                if(current!=0){ // ç¾åœ¨ã‚’è¶Šãˆãªã„ãªã‚‰æ¬¡æœˆã¸
                    next_url=['https://blog.ameba.jp/ucs/entry/srventrylist.do?',
                              'entry_ym=' + current].join('');
                    window.open( next_url, '_self'); }
                else{ // ç¾åœ¨ã‚’è¶ŠãˆãŸã‚‰0ãŒæˆ»ã‚Šåœæ­¢
                    when_edge(); }}}

        else{ // pageIDã‚’å«ã¿ æœˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ãªã„å ´åˆ
            end=document.querySelector('.pagingArea .disabled.next');
            if(!end){ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã®æœ«å°¾ã§ãªã‘ã‚Œã°åŒæœˆæ¬¡ãƒšãƒ¼ã‚¸ã¸
                pageid=parseInt(win_url.slice(7).slice(0, -16), 10) +1;
                next_url=['https://blog.ameba.jp/ucs/entry/srventrylist.do?',
                          'pageID=' + pageid + '&entry_ym=' + current].join('');
                window.open( next_url, '_self'); }
            else{ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã®æœ«å°¾ãªã‚‰æ¬¡æœˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
                current=make_next(current);
                if(current!=0){ // ç¾åœ¨ã‚’è¶Šãˆãªã„ãªã‚‰æ¬¡æœˆã¸
                    next_url=['https://blog.ameba.jp/ucs/entry/srventrylist.do?',
                              'entry_ym=' + current].join('');
                    window.open( next_url, '_self'); }
                else{ // ç¾åœ¨ã‚’è¶ŠãˆãŸã‚‰0ãŒæˆ»ã‚Šåœæ­¢
                    when_edge(); }}}


        function make_next(curr){
            let ym;
            let y;
            let m;
            ym=parseInt(curr, 10); // 10é€²æ•°å€¤åŒ–
            y=Math.floor(ym/100); // å¹´ã¯100ã§å‰²ã£ãŸå•†
            m=ym % 100; // æœˆã¯100ã§å‰²ã£ãŸä½™ã‚Š
            if(m !=12){
                ym=100*y + m +1; }
            else{
                ym=100*y + 101; }

            let now=new Date();
            if(ym > 100*now.getFullYear() + now.getMonth() +1){
                return 0; } // ç¾åœ¨ã®æœˆã‚’è¶Šãˆã‚‹å ´åˆã¯0ã‚’è¿”ã™
            else{
                return ym; }} // æ¬¡å¹´æœˆã®æ•°å€¤ã‚’è¿”ã™


        function make_curr(){
            let now=new Date();
            return 100*now.getFullYear() + now.getMonth() +1 }


        function when_edge(){
            blogDB[0][1]='s'; // é€£ç¶šå‹•ä½œãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            write_DB(); // DB ä¿å­˜
            control_pannel('e'); } // SNAPçµ‚äº†æ™‚ã®è¡¨ç¤ºã‚’ã•ã›ã‚‹

    } // next()



    function snap(){ // ãƒšãƒ¼ã‚¸å†…ã®ã€Œå…¬é–‹è¨­å®šã€ã‚’SNAPã™ã‚‹
        let win_url=window.location.search.substring(1,window.location.search.length);
        let entry_date=parseInt(win_url.slice(-6), 10); // SNAPã—ã¦ã„ã‚‹ç¾åœ¨ã®ã€Œå¹´æœˆ 6æ¡ã€
        if(!entry_date){ entry_date=make_curr(); }
        function make_curr(){
            let now=new Date();
            return 100*now.getFullYear() + now.getMonth() +1 }

        entry_id=document.querySelectorAll('input[name="entry_id"]');
        publish_f=document.querySelectorAll('input[name="publish_flg"]');

        for(let k=0; k< entry_id.length; k++){
            let index=entry_id_DB.indexOf(entry_id[k].value);
            if(index==-1){ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ
                blogDB.push([entry_id[k].value, publish_f[k].value, entry_date]); } // ç™»éŒ²ã‚’è¿½åŠ 
            else{ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãŸå ´åˆ
                blogDB[index]=[entry_id[k].value, publish_f[k].value, entry_date]; }} // ç™»éŒ²ã‚’æ›´æ–°


        let filter_date=blogDB.filter(function(value){
            return value[2]==entry_date; });

        if(filter_date.length>0){
            let pub_all=filter_date.filter(function(value){
                return value[1]==0; });
            blogMAP[year_index][month][0]=pub_all.length;

            let pub_dra=filter_date.filter(function(value){
                return value[1]==1; });
            blogMAP[year_index][month][1]=pub_dra.length;

            let pub_ame=filter_date.filter(function(value){
                return value[1]==2; });
            blogMAP[year_index][month][2]=pub_ame.length; }

        setTimeout(write_DB, 10);
        setTimeout(write_MAP, 10);

    } // snap()



    function now_year_disp(){
        let box=document.querySelector('#sorting');
        if(box){
            let now_year_snap=
                '<div class="div_add">'+
                arr_disp(year_index) +
                '</div>';

            let div0=box.querySelector('#div0');
            if(div0){
                div0.innerHTML=now_year_snap; }
            p_color();
            easy_go();
            map_select();
            about_comment(0); }}



    function map_select(){
        let div0=document.querySelector('#div0');
        if(div0){
            let sw=document.querySelector('#show_map');
            div0.onclick=function(e){
                e.preventDefault();
                let div_add=div0.querySelectorAll('.div_add');
                if(div_add.length>1){
                    now_year_disp();
                    sw.value='MAPå…¨ä½“ã‚’è¡¨ç¤º'; }
                else{
                    all_year_disp();
                    sw.value='MAPã‚’é™å®šè¡¨ç¤º'; }}}}



    function all_year_disp(){
        let box=document.querySelector('#sorting');
        if(box){
            let all_year_snap='';
            for(let k=0; k<blogMAP.length-1; k++){
                all_year_snap+=
                    '<div class="div_add">'+
                    arr_disp(k) +
                    '</div>'; }

            let div0=box.querySelector('#div0');
            if(div0){
                div0.innerHTML=all_year_snap; }
            p_color();
            easy_go();
            map_select();
            about_comment(1); }}



    function about_comment(n){
        let map_now;
        let map_year=document.querySelectorAll('.div_add');
        if(n==0){
            map_now=map_year[0]; }
        else{
            map_now=map_year[year_index]; }


        if(blogDB[0][2]==0 || blogDB[0][2]==4){
            let add_m=map_now.querySelectorAll('.m');
            add_m[month].style.outline='2px solid #2196f3'; }


        if(blogDB[0][2]>0 && blogDB[0][2]<4){
            let add_mp=map_now.querySelectorAll('.m p');
            let index=month*4 + blogDB[0][2];
            add_mp[index].style.outline='2px solid red';
            add_mp[index].style.position='relative'; }



        if(blogDB[0][2]>-1 && blogDB[0][2]<4){ // ä»¥ä¸‹ã¯MAPã®æ¤œè¨¼ã‚³ãƒ¼ãƒ‰
            let publish_f=document.querySelectorAll('input[name="publish_flg"]');
            pub_all=0;
            pub_dra=0;
            pub_ame=0;

            for(let k=0; k<publish_f.length; k++){
                if(publish_f[k].value==0){
                    pub_all+=1; }
                if(publish_f[k].value==1){
                    pub_dra+=1; }
                if(publish_f[k].value==2){
                    pub_ame+=1; }}

            let alert1=0; // MAPå€¤ã¨è¨˜äº‹ãƒªã‚¹ãƒˆæ•°ã®ä¸ä¸€è‡´
            let pagingArea=document.querySelector('form > .pagingArea');
            if(!pagingArea){
                if(pub_all!=blogMAP[year_index][month][0] ||
                   pub_dra!=blogMAP[year_index][month][1] ||
                   pub_ame!=blogMAP[year_index][month][2]){
                    alert1=1; }}
            else{
                if(pub_all>blogMAP[year_index][month][0] ||
                   pub_dra>blogMAP[year_index][month][1] ||
                   pub_ame>blogMAP[year_index][month][2]){
                    alert1=1; }
                if(blogDB[0][2]==0){
                    if((blogMAP[year_index][month][0]+blogMAP[year_index][month][1]+
                        blogMAP[year_index][month][2])<20){
                        alert1=1; }}}

            if(alert1==1){
                let box=document.querySelector('#sorting');
                if(box){
                    let com1='<p id="com1">MAPã¨è¨˜äº‹ãƒªã‚¹ãƒˆãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼šMAPã®èª¿æŸ»ãƒ»æ›´æ–°ã€€'+
                        'ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰MAPãƒ‡ãƒ¼ã‚¿ã®èª­è¾¼ã¿ãŒå¿…è¦ã§ã™</p>';
                    if(!box.querySelector('#com1')){
                        box.insertAdjacentHTML('afterbegin', com1); }}}


            if(blogDB[0][2]==1){
                if(pub_all<blogMAP[year_index][month][0]){
                    other_alert(pub_all, blogMAP[year_index][month][0]); }}
            if(blogDB[0][2]==2){
                if(pub_dra<blogMAP[year_index][month][1]){
                    other_alert(pub_dra, blogMAP[year_index][month][1]); }}
            if(blogDB[0][2]==3){
                if(pub_ame<blogMAP[year_index][month][2]){
                    other_alert(pub_ame, blogMAP[year_index][month][2]); }}

            function other_alert(count, map){
                let pagingArea=document.querySelector('form > .pagingArea');
                if(pagingArea){
                    let com2='<p id="com2">æŠ½å‡ºè¨˜äº‹ã®åˆ†æ•£ï¼š<b>'+ count + '</b>ã€€åˆ¥ãƒšãƒ¼ã‚¸ï¼š<b>'+
                        (map - count) +'</b></p>';
                    if(!pagingArea.querySelector('#com2')){
                        pagingArea.insertAdjacentHTML('beforeend', com2); }}}

        } // if(blogDB[0][2]>-1 && blogDB[0][2]<4)
    } // about_comment()



    function arr_disp(y){
        let arr=
            '<div class="m y_index"><p>'+blogMAP[y][0][1]+'<span class="yt">å¹´</span></p>'+
            '<p class="ypt">å…¨å“¡ã«å…¬é–‹</p><p class="ypt">ã€€ã€€'+
            'ä¸‹æ›¸ã</p><p class="ypt">ã‚¢ãƒ¡ãƒ³ãƒãƒ¼</p></div>'+
            '<div class="m"><p class="mt">1æœˆ</p><p>'+blogMAP[y][1][0]+'</p><p>'+
            blogMAP[y][1][1]+'</p><p>'+blogMAP[y][1][2]+'</p></div>'+
            '<div class="m"><p class="mt">2æœˆ</p><p>'+blogMAP[y][2][0]+'</p><p>'+
            blogMAP[y][2][1]+'</p><p>'+blogMAP[y][2][2]+'</p></div>'+
            '<div class="m"><p class="mt">3æœˆ</p><p>'+blogMAP[y][3][0]+'</p><p>'+
            blogMAP[y][3][1]+'</p><p>'+blogMAP[y][3][2]+'</p></div>'+
            '<div class="m"><p class="mt">4æœˆ</p><p>'+blogMAP[y][4][0]+'</p><p>'+
            blogMAP[y][4][1]+'</p><p>'+blogMAP[y][4][2]+'</p></div>'+
            '<div class="m"><p class="mt">5æœˆ</p><p>'+blogMAP[y][5][0]+'</p><p>'+
            blogMAP[y][5][1]+'</p><p>'+blogMAP[y][5][2]+'</p></div>'+
            '<div class="m"><p class="mt">6æœˆ</p><p>'+blogMAP[y][6][0]+'</p><p>'+
            blogMAP[y][6][1]+'</p><p>'+blogMAP[y][6][2]+'</p></div>'+
            '<div class="m"><p class="mt">7æœˆ</p><p>'+blogMAP[y][7][0]+'</p><p>'+
            blogMAP[y][7][1]+'</p><p>'+blogMAP[y][7][2]+'</p></div>'+
            '<div class="m"><p class="mt">8æœˆ</p><p>'+blogMAP[y][8][0]+'</p><p>'+
            blogMAP[y][8][1]+'</p><p>'+blogMAP[y][8][2]+'</p></div>'+
            '<div class="m"><p class="mt">9æœˆ</p><p>'+blogMAP[y][9][0]+'</p><p>'+
            blogMAP[y][9][1]+'</p><p>'+blogMAP[y][9][2]+'</p></div>'+
            '<div class="m"><p class="mt">10æœˆ</p><p>'+blogMAP[y][10][0]+'</p><p>'+
            blogMAP[y][10][1]+'</p><p>'+blogMAP[y][10][2]+'</p></div>'+
            '<div class="m"><p class="mt">11æœˆ</p><p>'+blogMAP[y][11][0]+'</p><p>'+
            blogMAP[y][11][1]+'</p><p>'+blogMAP[y][11][2]+'</p></div>'+
            '<div class="m"><p class="mt">12æœˆ</p><p>'+blogMAP[y][12][0]+'</p><p>'+
            blogMAP[y][12][1]+'</p><p>'+blogMAP[y][12][2]+'</p></div>';
        return arr;
    } // arr_disp(y)



    function p_color(){
        let box=document.querySelector('#sorting');
        if(box){
            let pub_all=box.querySelectorAll('.div_add .m p:nth-child(2)');
            for(let k=0; k<pub_all.length; k++){
                if(pub_all[k].textContent=='0'){
                    pub_all[k].style.color='transparent'; }}

            let pub_dra=box.querySelectorAll('.div_add .m p:nth-child(3)');
            for(let k=0; k<pub_dra.length; k++){
                if(pub_dra[k].textContent=='0'){
                    pub_dra[k].style.color='transparent'; }
                else{
                    pub_dra[k].style.background='#d7ecfd'; }}

            let pub_ame=box.querySelectorAll('.div_add .m p:nth-child(4)');
            for(let k=0; k<pub_ame.length; k++){
                if(pub_ame[k].textContent=='0'){
                    pub_ame[k].style.color='transparent'; }
                else{
                    pub_ame[k].style.background='#a3d8d4'; }}

        }} // p_color()



    function easy_go(){
        let add_mp=document.querySelectorAll('.div_add .m p');

        for(let k=0; k<add_mp.length; k++){
            add_mp[k].addEventListener('mouseenter', function(){
                if(!add_mp[k].classList.contains('mt')){
                    add_mp[k].closest('.m').style.outlineColor='transparent'; }});
            add_mp[k].addEventListener('mouseleave', function(){
                if(!add_mp[k].classList.contains('mt')){
                    add_mp[k].closest('.m').style.outlineColor='#2196f3'; }}); }

        for(let k=0; k<add_mp.length; k++){
            add_mp[k].addEventListener('click', function(e){
                if(!add_mp[k].closest('.m').classList.contains('y_index')){
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    jump_year(add_mp[k]); }
            }); }


        function jump_year(m_mp){
            let div_add=m_mp.closest('.div_add');
            let to_year=div_add.querySelector('.y_index p').textContent;
            to_year=to_year.replace(/[^0-9]/g, '');

            let div_m=m_mp.closest('.m');
            let to_month=div_m.querySelector('.mt').textContent;
            to_month=to_month.replace(/[^0-9]/g, '');
            if(to_month!='10' && to_month!='11' && to_month!='12'){
                to_month='0'+ to_month; }

            let month_p=div_m.querySelectorAll('p');
            if(m_mp==month_p[0]){
                blogDB[0][2]=0; } // MAPã®ã€Œæœˆæ ã€ã‚’é¸æŠ
            else if(m_mp==month_p[1]){
                blogDB[0][2]=1; } // MAPã®ã€Œå…¨ä½“ã«å…¬é–‹ã€ã‚’é¸æŠ
            else if(m_mp==month_p[2]){
                blogDB[0][2]=2; } // MAPã®ã€Œä¸‹æ›¸ãã€ã‚’é¸æŠ
            else if(m_mp==month_p[3]){
                blogDB[0][2]=3; } // MAPã®ã€Œã‚¢ãƒ¡ãƒ³ãƒãƒ¼ã€ã‚’é¸æŠ

            write_DB(); // DB ä¿å­˜

            let to_url=
                'https://blog.ameba.jp/ucs/entry/srventrylist.do?entry_ym='+ to_year + to_month;
            location.href=to_url; } // é¸æŠã—ãŸã€Œå¹´åº¦ãƒ»æœˆã€ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã

    } // easy_go()



    function menu(){
        let amb_menu2=document.querySelector('#amb_menu2');
        let amb_menu3=document.querySelector('#amb_menu3');

        if(blogDB[0][2]!=4){
            let show_map=document.querySelector('#show_map');
            show_map.onclick=function(e){
                e.preventDefault();
                let div0=document.querySelector('#div0');
                if(div0){
                    div0.click(); }}

            let start_page=document.querySelector('#start_page');
            start_page.onclick=function(e){
                e.preventDefault();
                blogDB[0][2]=0;
                write_DB();
                location.href=
                    'https://blog.ameba.jp/ucs/entry/srventrylist.do?entry_ym=100001'; }

            let do_snap=document.querySelector('#do_snap');
            do_snap.onclick=function(e){
                e.preventDefault();
                blogDB[0][2]=4;
                write_DB();
                location.reload(); }

            amb_menu3.onclick=function(e){
                e.preventDefault();
                if(blogDB[0][2]!=4){
                    blogDB[0][2]=5;
                    write_DB();
                    location.reload(); }}}

        else if(blogDB[0][2]==4){ // 4ã¯ Snapå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰
            amb_menu2.onclick=function(e){
                e.preventDefault();
                blogDB[0][2]=0;
                write_DB();
                location.reload(); }}

    } // menu()



    function blog_start(){
        let return_sw=document.querySelector('#entryYear a');
        if(return_sw){
            return_sw.click(); }}

});



